{% extends "base.html" %}

{% block extrahead %}
<style>
#results {
    border: 1px solid #ccc;
}
#results p.selected {
    background-color: #ccc;
}
</style>
{% endblock %}

{% block title_prefix %}Autocomplete Tester{% endblock %}

{% block content %}

<h2>Autocomplete Tester</h2>

<form action="/search">
  <input name="q" id="q" class="search-query" maxlength="90" placeholder="Search" type="text">
  <div id="results">
    <p><a href="/foo">Foo result</a></p>
    <p><a href="/foo">Some other search result</a></p>

  </div>
</form>

{% endblock %}


{% block extrajs %}
<script>
(function(window, document, undefined) {
  var q = document.getElementById('q');
  q.spellcheck = false;
  q.autocomplete = 'off';
  var r = document.getElementById('results');
  r.style.width = q.style.width;
  function displayResults(results) {
    if (results.length) {
      r.style.display = 'block';
      var ps = r.getElementsByTagName('p');
      for (var i=ps.length - 1; i >= 0; i--) {
        ps[i].remove();
      }
    } else {
      r.style.display = 'none';
    }

    var p, a;
    for (var i=0, len=results.length; i < len; i++) {
      p = document.createElement('p');
      a = document.createElement('a');
      a.textContent = results[i][2];
      a.href = results[i][0];
      p.appendChild(a);
      r.appendChild(p);
    }
  }

  function _characterFromEvent(e) {
    // for keypress events we should return the character as is
    if (e.type == 'keypress') {
        var character = String.fromCharCode(e.which);
        console.log('Character keypress:', character);
        return character;
    } else {
      return String.fromCharCode(e.which).toLowerCase();
    }
  }

  function handleKeyboardEvent(name) {
    console.log('Keyboard event', name);
  }

  function _handleKeyEvent(e) {
    /*
    var _MAP = {
            8: 'backspace',
            9: 'tab',
            13: 'enter',
            16: 'shift',
            17: 'ctrl',
            18: 'alt',
            20: 'capslock',
            27: 'esc',
            32: 'space',
            33: 'pageup',
            34: 'pagedown',
            35: 'end',
            36: 'home',
            37: 'left',
            38: 'up',
            39: 'right',
            40: 'down',
            45: 'ins',
            46: 'del',
            91: 'meta',
            93: 'meta',
            224: 'meta'
        },
        */
    var relevant_keycodes = {
      13: 'enter',
      9: 'tab',
      38: 'up',
      40: 'down'
    };
    if (!relevant_keycodes[e.keyCode]) return;
    handleKeyboardEvent(relevant_keycodes[e.keyCode]);
  }

  // _addEvent(document, 'keypress', _handleKeyEvent);
  //   _addEvent(document, 'keydown', _handleKeyEvent);
  //   _addEvent(document, 'keyup', _handleKeyEvent);

  function handler() {
    if (!q.value) return;
    var req;
    if (window.XMLHttpRequest) { // Mozilla, Safari, ...
        req = new XMLHttpRequest();
    } else if (window.ActiveXObject) { // IE 8 and older
        req = new ActiveXObject("Microsoft.XMLHTTP");
    }
    req.onreadystatechange = function() {
      if (req.readyState === 4 && req.status === 200) {
        displayResults(JSON.parse(req.responseText));
      }
    };
    req.open('GET', '/autocomplete?q=' + encodeURIComponent(q.value), true);
    req.send();
    // console.log(q.value);
  }

  if (q.addEventListener) {
      q.addEventListener("input",  handler, false);
      q.addEventListener('keypress', _handleKeyEvent, false);
      // q.addEventListener('keydown', _handleKeyEvent, false);
      // q.addEventListener('keyup', _handleKeyEvent, false);
  } else { // is this a fair assumption: that attachEvent will exist ?
      q.attachEvent('oninput', handler); // IE<9
  }
}) (window, document);
</script>
{% endblock %}
